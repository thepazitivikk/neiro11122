<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ø–æ–ü—É—Ç–∏</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
    <style>
        .session-card {
            position: relative;
            overflow: hidden;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: {% if stats.session_percent > 50 %}#28a745{% elif stats.session_percent > 20 %}#ffc107{% else %}#dc3545{% endif %};
            width: {{ stats.session_percent }}%;
            transition: width 1s ease, background 0.3s ease;
        }
        .session-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
        }
        .timer-number {
            font-size: 36px;
            font-weight: 700;
            color: {% if stats.session_percent > 50 %}#28a745{% elif stats.session_percent > 20 %}#ffc107{% else %}#dc3545{% endif %};
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }
    </style>
</head>
<body class="admin-dashboard">
    <header class="dashboard-header">
        <nav class="dashboard-nav">
            <div class="dashboard-brand">–ø–æ–ü—É—Ç–∏ | –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
            <div class="dashboard-user">
                {{ session.admin_session.name }}
                <a href="{{ url_for('admin_logout') }}" class="dashboard-logout">–í—ã–π—Ç–∏</a>
            </div>
        </nav>
    </header>

    <main class="dashboard-main">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'error' if category == 'error' else 'success' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if stats.session_minutes < 5 %}
        <div class="session-warning">
            ‚ö†Ô∏è –í—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è! –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
        </div>
        {% endif %}

        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-number">{{ stats.active_notifications }}</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_banners }}</div>
                <div class="stat-label">–í—Å–µ–≥–æ –±–∞–Ω–Ω–µ—Ä–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.active_banners }}</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –±–∞–Ω–Ω–µ—Ä–æ–≤</div>
            </div>
            <div class="stat-card session-card">
                <div class="timer-number" id="timerNumber">
                    {{ stats.session_minutes }}:{{ '%02d' % stats.session_seconds }}
                </div>
                <div class="stat-label">–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏<br>–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ, –≤—ã –ø–æ–∫–∏–Ω–∏—Ç–µ - —Å—Å–µ—Å–∏—é</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>

        <div class="dashboard-actions">
            <div class="action-card">
                <div class="action-icon">üì¢</div>
                <h3 class="action-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏</h3>
                <p class="action-description">–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>
                <a href="{{ url_for('admin_notifications') }}" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏</a>
            </div>

            <div class="action-card">
    <div class="action-icon">üè™</div>
    <h3 class="action-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞–º–∏</h3>
    <p class="action-description">–î–æ–±–∞–≤–ª—è–π—Ç–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –º–∞–≥–∞–∑–∏–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</p>
    <a href="{{ url_for('admin_stores') }}" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏</a>
</div>

            <div class="action-card">
                <div class="action-icon">üñºÔ∏è</div>
                <h3 class="action-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–Ω–Ω–µ—Ä–∞–º–∏</h3>
                <p class="action-description">–†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –±–∞–Ω–Ω–µ—Ä—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ</p>
                <a href="{{ url_for('admin_banners') }}" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏</a>
            </div>
        </div>
    </main>

    <script>
        // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ —Å–µ—Å—Å–∏–∏
        let minutes = {{ stats.session_minutes }};
        let seconds = {{ stats.session_seconds }};
        let totalSeconds = minutes * 60 + seconds;

        function updateTimer() {
            seconds--;
            totalSeconds--;

            if (seconds < 0) {
                minutes--;
                seconds = 59;
            }

            if (minutes < 0) {
                // –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞
                window.location.href = "{{ url_for('admin_logout') }}";
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
            const timerNumber = document.getElementById('timerNumber');
            timerNumber.textContent = minutes + ':' + (seconds < 10 ? '0' + seconds : seconds);

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            const progressPercent = Math.max(0, (totalSeconds / (15 * 60)) * 100);
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = progressPercent + '%';

            // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏
            if (totalSeconds < 300) { // –ú–µ–Ω—å—à–µ 5 –º–∏–Ω—É—Ç
                timerNumber.style.color = '#dc3545';
                progressFill.style.background = '#dc3545';
            } else if (totalSeconds < 600) { // –ú–µ–Ω—å—à–µ 10 –º–∏–Ω—É—Ç
                timerNumber.style.color = '#ffc107';
                progressFill.style.background = '#ffc107';
            } else {
                timerNumber.style.color = '#28a745';
                progressFill.style.background = '#28a745';
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –º–∞–ª–æ –≤—Ä–µ–º–µ–Ω–∏
            if (minutes === 1 && seconds === 0) {
                showSessionWarning();
            }

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –æ—Ç—Å—á–µ—Ç
            setTimeout(updateTimer, 1000);
        }

        function showSessionWarning() {
            if (!document.querySelector('.session-warning')) {
                const warning = document.createElement('div');
                warning.className = 'session-warning';
                warning.innerHTML = '‚ö†Ô∏è –í—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è! –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.';
                document.querySelector('.dashboard-main').insertBefore(warning, document.querySelector('.dashboard-stats'));
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
        document.addEventListener('DOMContentLoaded', function() {
            updateTimer();
        });

        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –µ—Å–ª–∏ –≤—Ä–µ–º—è –Ω–∞ –∏—Å—Ö–æ–¥–µ
        window.addEventListener('beforeunload', function(e) {
            if (minutes < 2) {
                e.preventDefault();
                e.returnValue = '–í—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ –ø–æ—á—Ç–∏ –∏—Å—Ç–µ–∫–ª–æ. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–π—Ç–∏?';
            }
        });
    </script>
</body>
</html>